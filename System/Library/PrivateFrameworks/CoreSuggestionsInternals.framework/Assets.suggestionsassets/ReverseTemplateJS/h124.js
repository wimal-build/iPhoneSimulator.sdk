// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,r,t){function a(e,r){f=e.innerCapture(x),A=y=null;var t;f&&(t=H[""+f.$month]||""+f.$month,A=i.getDetachedSpan(""+f.$day+("MAY"===t?"":" ")+t+" "+f.$time).innerDate()),C=r.innerCapture(x);var a="";return C?(t=H[""+C.$month]||""+C.$month,a=""+C.$day+("MAY"===t?"":" ")+t+" "+C.$time):F.test(r)&&f&&(a=""+f.$day+("MAY"===t?"":" ")+t+" "+r.innerCapture(F,1)),y=i.getDetachedSpan(a).innerDate(),!C&&Date.parse(i.getDateDD(y).iso8601)<Date.parse(i.getDateDD(A).iso8601)&&(y=modifyDate(y,1,0,0,0)),{departureTime:A,arrivalTime:y}}function n(){function e(e){for(var r={},t=1,a=[],n=0;e.length>n;n++)r[e[n]]||(r[e[n]]=t++),a.push(r[e[n]]);return a}if(E.length){for(var r,t=[],a=i.getSpan().firstRegExp(/.*Baggage charges for your itinerary will be governed by.*/),n=a.allInnerCapture(/BAG ALLOWANCE -($<origin>[A-Z]{3})($<destination>[A-Z]{3})-/),g=0;r=n[g];g++)t.push(r.$origin,r.$destination);if(E.length===t.length/2)for(var g=0;E.length>g;g++)$[E[g].departureAirport]=t[2*g],$[E[g].arrivalAirport]=t[2*g+1];else{if($[E[0].departureAirport]=t[0],$[E[E.length-1].arrivalAirport]=t[t-1],E.length%2===0){for(var l=!0,g=0;E.length/2>g;g++){var p=E[g],s=E[E.length-1-g];if(p.departureAirport.getString()!==s.arrivalAirport.getString()||p.arrivalAirport.getString()!==s.departureAirport.getString()){l=!1;break}}if(l){var o=t.slice();if(o.reverse(),arraysEqual(t,o)){var m=E[E.length/2];$[m.departureAirport]=t[t.length/2]}}}for(var u=[],g=0;E.length>g;g++){var d=E[g];$[d.departureAirport]||u.push(d.departureAirport.getString()),$[d.arrivalAirport]||u.push(d.arrivalAirport.getString())}for(var h={},T=Object.keys($),g=0;T.length>g;g++)h[$[T[g]]]=!0;for(var v=[],g=0;t.length>g;g++)h[t[g]]||v.push(t[g]);if(arraysEqual(e(u),e(v)))for(var g=0;u.length>g;g++)$[u[g]]=v[g]}}}if(!e||!r||!t)return CONTINUE;t.itineraryHeader=t.itineraryHeader||[],t.passengerHeader=t.passengerHeader||[];var i=Scanner.fromMessage(e);i.setLocale(r);var g,l,p,s,o,m,u,d,h,T,v,f,A,N,c,C,y,b,I,E=[],S={},x=/($<day>\d{2})($<month>\w{3})\s+($<time>.*)/,F=/(\d{1,2}:\d{2}\s*(?:[A|P]M|N)?)/,H={ABR:"APR"},$={"DALLAS FT WORTH":"DFW","NEW YORK JFK":"JFK","LOS ANGELES":"LAX","MIAMI INTERNTNL":"MIA","CHICAGO OHARE":"ORD",CHARLOTTE:"CLT",PHILADELPHIA:"PHL",PHOENIX:"PHX","WASHINGTON REAGAN":"DCA"};if("VERSION 1"===t.emailType){if(G=i.getSpan().next(t.passengerHeader[0]),G=G.parentTag("table3").allInnerTags("table4"),!G.length)return CONTINUE;var D,s,O=G[0].allInnerTagsFiltered("td4"),R=G[1].allInnerTags("td4");G.length>2&&(D=G[G.length-1].allInnerTags("td4"),s=G[G.length-3].innerTag("td4").tagContents().innerCapture(/-([A-Z]{3})$/,1));for(var P=1;O.length>P;P++)o=O[P],S[""+o]={name:o,seats:{},seatingType:{},ticketNumber:R?R[P].tagContents():null,totalPrice:D?D[P].tagContents():null,priceCurrency:s};for(var L=i.getSpan(),P=0,k=t.itineraryHeader.length;k>P;P++)L=L.nextText(t.itineraryHeader[P]);if(L=L.parentTag("tr2"),!L.exists())return CONTINUE;u=L.parentTag("table2").withStart(L.getStart()).allInnerTags("tr3");for(var M,U,z,P=2;u.length>P;){for(M=u[P].allInnerTagsFiltered("td3"),T=M[0],v="AA",d=M[1],N=M[2],b=M[4],m=a(M[3],M[5]),A=m.departureTime,y=m.arrivalTime,z=P+1,U=0;u.length>z&&u[z].allInnerTagsFiltered("td3").length<7;z++,U++);for(var w=1;U>=w;w++)regExpFormatted(/\1/,t.operatedBy).test(""+u[P+w])||(h=u[P+w].allInnerTags("td3"),o=(""+h[0].tagContents()).toUpperCase(),valid(d)&&S[o]&&(valid(S[o].membershipNumber)||(S[o].membershipNumber=h[1].tagContents().innerCapture(regExpFormatted(/\1: (.*)/,t.ff),1)),S[o].seatingType[""+d]=h[2].tagContents(),S[o].seats[""+d]=h[3].tagContents().innerCapture(regExpFormatted(/\1 (.*)/,t.seat),1)));ASSERT(T,v,d,N,A,b,y)&&E.push({airlineName:T,airlineCode:v,flightNumber:d,departureAirport:N,departureTime:A,arrivalAirport:b,arrivalTime:y,passengers:S}),T=v=d=N=A=c=b=y=I=null,P+=1+U}g=i.getSpan().nextRegExp(regExpFormatted(/\1/,t.reservationIdPrefix)).parentAnyTag("td").tagContents().innerCapture(regExpFormatted(/\1:\s+(.*)/,t.reservationIdPrefix),1)}else if("VERSION 2"==t.emailType){for(var G=i.getSpan(),P=0,k=t.passengerHeader.length-1;k>P;P++)G=G.firstText(t.passengerHeader[P]);if(G=G.parentTag("table1").allInnerTags("tr1").map(function(e){return e.allInnerTagsFiltered("td1")}).filter(function(e){return e.length>0}),!G.length)return CONTINUE;G[0].length>2&&(s=G[0][G[0].length-3].innerCapture(/-([A-Z]{3})/,1));for(var P=1,k=G.length;k>P;P++)h=G[P],h.length>=2&&(o=h[0],S[""+o]={name:o,ticketNumber:h[1],totalPrice:h.length>=5?h[h.length-1]:null,priceCurrency:s,seats:{},seatingType:{}});for(var L=i.getSpan(),P=0,k=t.itineraryHeader.length;k>P;P++)L=L.nextText(t.itineraryHeader[P]);if(L=L.parentTag("tr2"),!L.exists())return CONTINUE;u=L.parentTag("table2").withStart(L.getEnd()).allInnerTags("tr2");for(var M,W,Z,P=0;u.length>P;P++)u[P].innerDate().exists()?(M=u[P].allInnerTagsFiltered("td2"),W=Z=T=v=d=N=A=b=y=null,W=M[2].split("\n"),Z=M[3].split("\n"),T=M[0],v="AA",d=M[1].trim(),N=W[0].trim(),b=Z[0].trim(),m=a(M[2],M[3]),A=m.departureTime,y=m.arrivalTime,ASSERT(T,v,d,N,A,b,y)&&E.push({airlineName:T,airlineCode:v,flightNumber:d,departureAirport:N,departureTime:A,arrivalAirport:b,arrivalTime:y,passengers:S})):u[P].allInnerTagsFiltered("td2").length>=2&&(M=u[P].allInnerTags("td2"),M.length>=5&&(o=""+M[1].tagContents(),valid(d)&&S[o]&&(p=M[4].tagContents().innerCapture(regExpFormatted(/^\1:\s+(($<program>[A-Z]+)\s)?($<number>\w+)/,t.ff)),!valid(S[o].membershipNumber)&&valid(p)&&(S[o].programName=p.$program.result(),S[o].membershipNumber=p.$number.result()),S[o].seats[""+d]=M[2].tagContents().innerCapture(regExpFormatted(/^\1\s*([^\s]*)/,t.seat),1),S[o].seatingType[""+d]=M[3].tagContents())));g=i.getSpan().nextRegExp(regExpFormatted(/\1/,t.reservationIdPrefix)).nextAnyTag("td").tagContents(),n()}l=i.getSpan().firstText(t.checkinPrefix).nextLink();for(var B=[],P=0;E.length>P;P++)for(var Y=E[P],O=Object.keys(Y.passengers),q=0;O.length>q;q++){var K=Y.passengers[O[q]],X={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:Y.airlineName,airlineCode:Y.airlineCode,flightNumber:Y.flightNumber,departureAirportFuzzy:Y.departureAirport,departureAirportCode:$[""+Y.departureAirport],departureTime:Y.departureTime,arrivalAirportFuzzy:Y.arrivalAirport,arrivalAirportCode:$[""+Y.arrivalAirport],arrivalTime:Y.arrivalTime},underName:{"@type":"http://schema.org/Person",name:K.name},checkinUrl:l,reservationId:g,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:K.totalPrice,priceCurrency:K.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:K.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatingType:K.seatingType[Y.flightNumber],seatNumber:K.seats[Y.flightNumber]}}};valid(K.membershipNumber)&&(X.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:K.membershipNumber,programName:K.programName||"Frequent Flyer"}),B.push(X)}return B.length?B:void 0}}).call();
