// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,r,t){if(!e||!r||!t)return CONTINUE;var a=Scanner.fromMessage(e);a.setLocale(r);var n,i,o,p,s,d,l,g,m,c,h,u,v,T,x,f,y,C,A,b,S,N,k,F,P,R,I,E,$,D,U,z,O=[],L=[],M={},j=[],B=[];if(l=a.getSpan().innerCapture(regExpFormatted(/\b\1 (\d+)/,t.reservationId),1),S=a.getSpan().next(t.totalPrice).nextTag("td8").tagContents(),s=S.innerCapture(/([\d,.]+)/,1),d=S.innerCapture(/([^\d,.]+)/,1),a.getSpan().nextRegExp(regExpFormatted(/\1/,t.flight.names)).exists()){i=a.getSpan().innerCapture(regExpFormatted(/\1 (.*)\s/,t.flight.names),1),i=i.split(", ");for(var Z=0,q=i.length;q>Z;Z++)M[""+i[Z]]={name:i[Z],seats:{},seatingType:{},totalPrice:s,priceCurrency:d};if(Object.keys(M).length){p=a.getSpan().nextRegExp(regExpFormatted(/\1/,t.flight.names)).previousAnyTag("table"),o=p.getTagNumber(),p=p.nextTag("table"+o),p.inner(t.taxes).exists()&&(p=p.nextTag("table"+o)),p=p.allInnerTags("tr"+o).map(function(e){return e.allInnerTagsFiltered("td"+o)}).filter(function(e){return e.length>=4});for(var Z=0,q=p.length;q>Z;Z++)c=p[Z],h=c[0].innerCapture(regExpFormatted(/($<departureAirport>.*)\s+\((?:($<departureCode>[A-Z].*)\))?\s+\1\s+($<arrivalAirport>.*)\s+\((?:($<arrivalCode>.*)\))?/,t.flight.to)),h&&(f=h.$departureAirport,3===(""+h.$departureCode).length&&(y=h.$departureCode),A=h.$arrivalAirport,3===(""+h.$arrivalCode).length&&(b=h.$arrivalCode)),m=c[1].innerDate(),g=a.getDateDD(c[2].innerDate()),g.endIso8601&&(x=combineDateAndTime(m,g.iso8601),C=combineDateAndTime(m,g.endIso8601)),u=c[3].innerCapture(/($<name>.*) ($<flightNumber>\d+)/),v=u?u.$name:null,T=u?u.$flightNumber:null,ASSERT(v,T,x,OR(y,f),C,OR(b,A))&&L.push({airlineName:v,flightNumber:T,reservationId:l,departureAirport:f,departureCode:y,departureTime:x,arrivalAirport:A,arrivalCode:b,arrivalTime:C,passengers:M})}}if(a.getSpan().nextText(t.hotel.name).exists()){n=a.getSpan().innerCapture(regExpFormatted(/\1\s+(.*) -/,t.hotel.name),1),not(s)&&(s=a.getSpan().nextText(t.hotel.totalPrice).nextTag("td8").tagContents().innerCapture(/([\d,.]+)/,1)),p=n.nextAnyTag("table"),o=p.getTagNumber(),p.inner(t.taxes).exists()&&(p=p.nextTag("table"+o)),p=p.allInnerTagsFiltered("td"+o),F=p[0],R=s.nextTag("table7").innerAddress(),P=s.nextTag("table7").innerPhoneNumber();for(var w,G="",H=1;p.length>H;H++)if(p[H].innerCapture(regExpFormatted(/^\1/,t.hotel.telephone))){for(var J=H-1;J>0;J--)G=p[J]+"\n"+G;(not(R)||G.length>R.getLength())&&(R=G),w=p[H].innerCapture(regExpFormatted(/^\1 (.*)/,t.hotel.telephone),1),valid(w)&&(not(P)||valid(P)&&w.getLength()>P.getLength())&&(P=w)}else p[H].innerCapture(regExpFormatted(/^\1/,t.hotel.checkin))?N=p[H].innerDate():p[H].innerCapture(regExpFormatted(/^\1/,t.hotel.checkout))&&(k=p[H].innerDate());ASSERT(R,N,k)&&j.push({name:n,reservationId:l,totalPrice:s,hotelName:F,hotelAddress:R,hotelPhone:P,checkInDateTime:N,checkOutDateTime:k})}a.getSpan().nextText(t.car.name).exists()&&(n=a.getSpan().nextText(t.car.name).parentAnyTag("td").innerCapture(regExpFormatted(/\b\1 (.*)\s/,t.car.name),1),s=a.getSpan().nextText(t.car.totalPrice).nextAnyTag("td").tagContents().innerCapture(/([\d,.]+)/,1),E=a.getSpan().nextText(t.car.provider).parentAnyTag("td").tagContents().innerCapture(regExpFormatted(/\1 (.*?),/,t.car.provider),1),I=a.getSpan().nextText(t.car.totalPrice).nextTag("table7").allInnerTagsFiltered("td7")[0],z=getFuzzyDate(a.getSpan().next(t.car.pickup).parentAnyTag("td")),U=a.getSpan().next(t.car.pickup).parentAnyTag("td"),U=U.innerAddress().exists()?U.tagContents().innerCapture(/(.*)$/,1):n.parentAnyTag("td").innerAddress().exists()?n.parentAnyTag("td").innerAddress():null,D=getFuzzyDate(a.getSpan().next(t.car.dropoff).parentAnyTag("td")),$=a.getSpan().next(t.car.dropoff).parentAnyTag("td"),$=$.innerAddress().exists()?$.tagContents().innerCapture(/(.*)$/,1):n.parentAnyTag("td").innerAddress().exists()?n.parentAnyTag("td").innerAddress():null,ASSERT(n,z,E)&&B.push({name:n,reservationId:l,totalPrice:s,pickupTime:z,pickupAddress:U,dropoffTime:D,dropoffAddress:$,brand:I,provider:E}));for(var K,Q,Z=0;L.length>Z;Z++){Q=L[Z];for(var V=Object.keys(Q.passengers),W=0;V.length>W;W++){var X=Q.passengers[V[W]];K={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:Q.airlineName,airlineCode:Q.airlineCode,flightNumber:Q.flightNumber,departureAirportFuzzy:Q.departureAirport,departureAirportCode:Q.departureCode,departureTime:Q.departureTime,arrivalAirportFuzzy:Q.arrivalAirport,arrivalAirportCode:Q.arrivalCode,arrivalTime:Q.arrivalTime},underName:{"@type":"http://schema.org/Person",name:X.name},checkinUrl:Q.checkinUrl,reservationId:Q.reservationId,reservationStatus:"http://schema.org/Reservation"+(Q.reservationStatus||"Confirmed"),totalPrice:X.totalPrice,priceCurrency:X.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:X.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:X.seats[Q.flightNumber],seatingType:X.seatingType[Q.flightNumber]}}},valid(X.membershipNumber,X.programName)&&(K.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:X.membershipNumber,programName:X.programName}),O.push(K)}}for(var Y,Z=0;B.length>Z;Z++)Y=B[Z],K={"@context":"http://schema.org","@type":"http://schema.org/RentalCarReservation",totalPrice:Y.totalPrice,priceCurrency:Y.priceCurrency,reservationId:Y.reservationId,reservationStatus:"http://schema.org/Reservation"+(Y.reservationStatus||"Confirmed"),checkinUrl:Y.checkinUrl,modifyReservationUrl:Y.modifyReservationUrl,cancelReservationUrl:Y.cancelReservationUrl,underName:{"@type":"http://schema.org/Person",name:Y.name,email:Y.email},provider:{"@type":"http://schema.org/Organization",name:Y.provider},pickupTime:Y.pickupTime,pickupLocation:{"@type":"http://schema.org/Place",name:Y.pickupName,telephone:Y.pickupTelephone,address:Y.pickupAddress},dropoffTime:Y.dropoffTime,dropoffLocation:{"@type":"http://schema.org/Place",name:Y.dropoffName,telephone:Y.dropoffTelephone,address:Y.dropoffAddress}},Y.brand&&(K.reservationFor={"@type":"http://schema.org/Car",brand:{"@type":"http://schema.org/Organization",name:Y.brand},license:Y.license,color:Y.color}),O.push(K);for(var _,Z=0;j.length>Z;Z++)_=j[Z],K={"@context":"http://schema.org","@type":"http://schema.org/LodgingReservation",underName:{"@type":"http://schema.org/Person",name:_.name,email:_.email},totalPrice:_.totalPrice,priceCurrency:_.priceCurrency,checkinTime:_.checkInDateTime,checkoutTime:_.checkOutDateTime,modifyReservationUrl:_.modifyReservationUrl,cancelReservationUrl:_.cancelReservationUrl,reservationStatus:"http://schema.org/Reservation"+(_.reservationStatus||"Confirmed"),reservationId:_.reservationId,reservationFor:{"@type":"http://schema.org/LodgingBusiness",name:_.hotelName,url:_.hotelUrl,telephone:_.hotelPhone,address:_.hotelAddress}},O.push(K);return O.length?O:void 0}}).call();
