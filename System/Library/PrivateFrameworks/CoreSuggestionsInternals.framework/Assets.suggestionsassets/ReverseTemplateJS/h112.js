// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,r,t){var a=Scanner.fromMessage(e);a.setLocale(r);var n,i,p,o=[],s=[],l=[],u=parseMicrodata(e.html),g=[];for(p=0;u.length>p;p++)"http://schema.org/FlightReservation"===u[p]["@type"]&&g.push(u[p]);var d,m,v,h,c,x,y,A,C,T;n=regExpFormatted(/\1\s*(.*)/,t.reservationId).exec(e.subject)[1];var f="U2";v=a.getSpan().next(t.itinerary),A=a.getSpan().next(t.payment).nextAnyTag("table").nextAnyTag("td").nextAnyTag("td").tagContents().innerCapture(regExpFormatted(/\1\s*(.*)\s\2\s/,t.paymentPreFix,t.paymentPostFix),1),C=A.innerCapture(/([\d,.]+)/,1),T=A.innerCapture(/([^\d,.]+)/,1).trim(),d=v.next(t.passengers).parentAnyTag("table").allInnerTags("td5");for(var F=1;d.length>F;F++)m={},m.name=d[F].tagContents(),s.push(m);for(c=v.next(t.arrival);c.exists();)x={},h=c.previous(t.departure),y=h.previousAnyTag("td").previousAnyTag("td").tagContents().innerCapture(regExpFormatted(/($<departure>.*) \1 ($<arrival>\w+)/,t.arrivalAirport)),x.departureAirport=y.$departure.trim(),x.arrivalAirport=(""+y.$arrival).replace("(Flexible)","").trim(),x.departureDate=h.nextDate(),x.arrivalDate=c.nextDate(),x.flightNumber=c.next(t.flight).parentAnyTag("td").tagContents().innerCapture(/(\d+)/,1),x.seats=(""+c.next(t.seat).nextAnyTag("td").tagContents()).split(", "),c=c.next(t.arrival),ASSERT(x.flightNumber,x.departureDate,x.departureAirport,x.arrivalDate,x.arrivalAirport)&&l.push(x);for(p=0;l.length>p;p++){x=l[p];for(var b=g[p].reservationFor,N=0;s.length>N;N++){m=s[N];var S={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:b.airline.name,airlineCode:f,flightNumber:b.flightNumber,departureAirportFuzzy:b.departureAirport.name,departureAirportCode:b.departureAirport.iataCode,departureTime:b.departureTime,arrivalAirportFuzzy:b.arrivalAirport.name,arrivalAirportCode:b.arrivalAirport.iataCode,arrivalTime:b.arrivalTime},underName:{"@type":"http://schema.org/Person",name:m.name},reservationId:n,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:C,priceCurrency:T,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:i,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:x.seats[N]}}};o.push(S)}}return o.length?o:void 0}}).call();