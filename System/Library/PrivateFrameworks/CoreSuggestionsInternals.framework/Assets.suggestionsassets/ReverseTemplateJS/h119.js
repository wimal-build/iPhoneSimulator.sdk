// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,t,r){var a=Scanner.fromMessage(e);a.setLocale(t);var n,i,l={},o=[],g={};n=a.getSpan().innerCapture(regExpFormatted(/\1: (.*?) /,r.bookingCode),1);var s=a.getSpan().firstText(r.passengersHeader).nextTag("table9").allInnerTags("tr9");if(s){nbPassengers=s.length-1;for(var p=1;nbPassengers+1>p;p++){var d=s[p].allInnerTags("td9"),u=(""+d[0].tagContents()).trim(),m=regExpFormatted(/\1/,r.child.toLowerCase()).test(u.toLowerCase())?"child":"adult";u=u.replace(/\(.*\)/,"").trim();var c=""+d[1].tagContents();c==r.withoutCard&&(c=""),ticket=""+d[2].tagContents(),l[u]={ticketNumber:ticket,membershipNumber:c,ageCategory:m}}}var h=a.getSpan().firstText(r.reservationDetails).nextText(r.flightDetails).nextTag("table8").allInnerTags("table9");if(h){for(var v={},p=0,C=h.length;C>p;p++)regExpFormatted(/\1.*\2/,r.departure,r.arrival).test(""+h[p])&&(v[p]=1);for(var p in v){var T=h[p].nextTag("tr9").nextTag("td9").nextTag("td9").tagContents(),f=h[p].nextTag("tr9").nextTag("tr9").allInnerTags("td9"),x="Iberia",b="IB",y=T.innerCapture(r.flightNumber);b=""+y.$airlineCode,T=""+y.$flightNumber;{var N=getFuzzyDate(f[1]),F=f[1].tagContents().innerCapture(/\n($<name>.*) \(($<code>[A-Z]{3})\)/),A=F?F.$name:null,k=F?F.$code:null,S=getFuzzyDate(f[2]),z=f[2].tagContents().innerCapture(/\n($<name>.*) \(($<code>[A-Z]{3})\)/),$=z?z.$name:null,I=z?z.$code:null;""+f[4].tagContents()}ASSERT(x,T,k,N,I,S)&&o.push({airlineName:x,airlineCode:b,flightNumber:T,departureAirport:A,departureCode:k,departureTime:N,arrivalAirport:$,arrivalCode:I,arrivalTime:S})}}var E=a.getSpan().firstText(r.priceHeader).nextTag("table8").nextTag("table9").allInnerTags("tr9");if(E){i=""+a.getSpan().firstText(r.totalPrice).nextTag("td9").tagContents().trim(),i=i.charAt(i.length-1);for(var P=E.length-1,p=1;P+1>p;p++){var D,d=E[p].allInnerTags("td9"),D=regExpFormatted(/\1/,r.adult).test(""+d[0])?"adult":regExpFormatted(/\1/,r.child).test(""+d[0])?"child":null;valid(D)&&(g[D]=""+d[5].tagContents())}}var w=[];for(p=0;o.length>p;p++)for(var L=o[p],R=Object.keys(l),H=0;R.length>H;H++){var Z=l[R[H]],j=g[Z.ageCategory],B={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:L.airlineName,airlineCode:L.airlineCode,flightNumber:L.flightNumber,departureAirportFuzzy:L.departureAirport,departureAirportCode:L.departureCode,departureTime:L.departureTime,arrivalAirportFuzzy:L.arrivalAirport,arrivalAirportCode:L.arrivalCode,arrivalTime:L.arrivalTime},underName:{"@type":"http://schema.org/Person",name:R[H],email:""},checkinUrl:"",reservationId:n,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:j,priceCurrency:i,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:Z.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:"",seatingType:""}}};w.push(B)}return w.length?w:void 0}}).call();