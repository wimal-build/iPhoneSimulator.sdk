// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,t,r){var a=Scanner.fromMessage(e);a.setLocale(t);var n,i,p,o,m,s,g,l,u,d,c,h,T,C,f,v,y,b,x=[],N={};n=a.getSpan().nextRegExp(/[Cc]onfirmation code:/).parentAnyTag("td").tagContents().innerCapture(/\b[Cc]onfirmation code:\s+(\w+)/,1),not(n)&&(n=a.getSpan().nextRegExp(/Confirmation code:/).nextAnyTag("td").tagContents()),o=a.getSpan().nextText("Passenger name").parentTag("table3").withStart(a.getSpan().nextText("Passenger name").getEnd()).allInnerTags("tr3"),u=a.getSpan().nextText("Total fare").nextTag("td3").tagContents().innerCapture(/([\d,.]+)/,1),not(u)&&(c=a.getSpan().nextText("Fare total").nextTag("td4").tagContents().innerCapture(/($<total>[\d,.]+)\s+($<currency>[\w]+)/),u=c?c.$total:null,d=c?c.$currency:null);for(var S=0,A=o.length;A>S;S++)h=o[S].allInnerTags("td3").map(function(e){return e.tagContents()}),p=""+h[0],N[p]={name:p,programName:"Frequent Flyer",membershipNumber:h[1],ticketNumber:h[2],seats:{},seatingType:{},totalPrice:u,priceCurrency:d};g=a.getSpan().nextText("Trip details").parentTag("table3").allInnerTags("tr3").map(function(e){return e.allInnerTags("td3").map(function(e){return e.tagContents()})}).filter(function(e){return e.length>0});for(var $,F=/^($<time>\d{1,2}:\d{2} [A|P]M)\s+($<code>[A-Z]{3})$/,k=/Flight # (\d+) : Arrives next day,/,D=0;g.length>D;D++)if(h=g[D],h[0].innerCapture(/^(?:Depart|Return)/))s=h[0].nextText("Date:").nextDate();else if(h[1]&&h[1].innerCapture(F)){l=h[0],T=h[1].innerCapture(F),C=a.getDetachedSpan(""+s+" "+T.$time).innerDate(),f=T.$code,v=h[2].innerCapture(F),y=a.getDetachedSpan(""+s+" "+v.$time).innerDate(),b=v.$code;var P=h[h.length-2];m=h[h.length-1].split(" "),o=Object.keys(N);for(var S=0;S<Math.min(o.length,m.length);S++)N[o[S]].seats[l]=m[S].trim(),N[o[S]].seatingType[l]=P;ASSERT(l,C,f,y,b)&&x.push({airlineCode:"US",flightNumber:l,reservationId:n,departureCode:f,departureTime:C,arrivalCode:b,arrivalTime:y,passengers:N})}else if(h[0].innerCapture(k)){$=h[0].innerCapture(k,1);for(var z=x.length;z-- >0&&(x[z].arrivalTime=modifyDate(x[z].arrivalTime,1),""+x[z].flightNumber!=""+$);)x[z].departureTime=modifyDate(x[z].departureTime,1)}for(var I=[],D=0;x.length>D;D++)for(var R=x[D],M=Object.keys(R.passengers),E=0;M.length>E;E++){var U=R.passengers[M[E]],w={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:R.airlineName,airlineCode:R.airlineCode||"US",flightNumber:R.flightNumber,departureAirportFuzzy:R.departureAirport,departureAirportCode:R.departureCode,departureTime:R.departureTime,arrivalAirportFuzzy:R.arrivalAirport,arrivalAirportCode:R.arrivalCode,arrivalTime:R.arrivalTime},underName:{"@type":"http://schema.org/Person",name:U.name,email:U.email},checkinUrl:i,reservationId:n,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:U.totalPrice,priceCurrency:U.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:U.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:U.seats[R.flightNumber],seatingType:U.seatingType[R.flightNumber]}}};valid(U.membershipNumber,U.programName)&&(w.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:U.membershipNumber,programName:U.programName}),I.push(w)}return I.length?I:void 0}}).call();
