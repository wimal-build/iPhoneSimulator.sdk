// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,t,r){var a=Scanner.fromMessage(e);a.setLocale(t);var n,i,s,o,g,p,m,l,d,u,T,c,h,C,x,v,b,f,y,A,N,S=[],F={};r.isCancelled&&(T="Cancelled");var I=a.getSpan().nextRegExp(/[Cc]onfirmation code:/).parentAnyTag("td").tagContents().innerCapture(/\b[Cc]onfirmation code:\s+(\w+)/,1),E={};if(not(I)){I=a.getSpan().nextRegExp(/Confirmation code:/).nextAnyTag("td").tagContents(),C=a.getSpan().nextRegExp(/Confirmation code:/).parentAnyTag("table"),g=int(C.getTagNumber())+1,C=C.nextTag("table"+g).allInnerTags("tr"+g).map(function(e){return e.allInnerTagsFiltered("td"+g)}).filter(function(e){return 2===e.length});for(var R=0;C.length>R;R++)E[C[R][1].innerCapture(/^([\w ]+)/,1).trim()]=""+C[R][0]}o=a.getSpan().nextText("Passenger name").parentTag("table3").withStart(a.getSpan().nextText("Passenger name").getEnd()).allInnerTags("tr3"),c=a.getSpan().nextText("Total fare (All passengers)").nextAnyTag("td").tagContents().innerCapture(/([\d,.]+)/,1);for(var k=0,D=o.length;D>k;k++)C=o[k].allInnerTags("td3").map(function(e){return e.tagContents()}),s=""+C[0],F[s]={name:s,programName:"Frequent Flyer",membershipNumber:""+C[1]!="None listed"&&C[1],ticketNumber:C[2],seats:{},seatingType:{},totalPrice:c,priceCurrency:h};d=a.getSpan().nextRegExp(/[Tt]rip details/).parentTag("table3").allInnerTags("table4").filter(function(e){return/(FLIGHT|DEPART)/.test(e)||e.innerDate().exists()});for(var P=/Flight # (\d+) : Arrives next day,/,w=0;d.length>w;w++)if(d[w].innerText("FLIGHT#").exists()&&d[w-1]&&d[w+1]){/Stop: Change plane/.test(d[w].previousAnyTag("table"))||(l=d[w-1].tagContents().innerDate()),u=d[w].tagContents().innerCapture(/FLIGHT# (\w+)/,1),x=d[w].tagContents().innerCapture(/Operated by (.+)/,1),v=d[w+1].nextText("DEPART").nextTag("td4").nextTag("td4").tagContents(),b=combineDateAndTime(l,v.innerDate()),f=v.innerCapture(/\s([A-Z]{3})$/,1),y=d[w+1].nextText("ARRIVE").nextTag("td4").nextTag("td4").tagContents(),A=combineDateAndTime(l,y.innerDate()),d[w+2]&&d[w+2].innerCapture(P)&&(A=modifyDate(A,1)),N=y.innerCapture(/\s([A-Z]{3})/,1),n=E[""+x]||I;var z=d[w+1].nextText("CABIN").nextTag("td4").nextTag("td4").tagContents();for(m=[],p=d[w+1].nextText("SEATS").nextTag("td4").nextTag("td4").tagContents();p.innerCapture(/([\dA-Z]+) </,1).exists();){var L=p.innerCapture(/(\w+) </,1);m.push(L),p=p.withStart(L.getEnd())}if(valid(u)){o=Object.keys(F);for(var k=0;o.length>k;k++)F[o[k]].seats[""+u]=m[k],F[o[k]].seatingType[""+u]=z}ASSERT(u,b,f,A,N)&&S.push({airlineName:x,flightNumber:u,departureCode:f,departureTime:b,arrivalCode:N,arrivalTime:A,reservationId:n,passengers:F})}for(var G=[],w=0;S.length>w;w++)for(var H=S[w],M=Object.keys(H.passengers),O=0;M.length>O;O++){var U=H.passengers[M[O]],Z={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:H.airlineName,airlineCode:H.airlineCode||"US",flightNumber:H.flightNumber,departureAirportFuzzy:H.departureAirport,departureAirportCode:H.departureCode,departureTime:H.departureTime,arrivalAirportFuzzy:H.arrivalAirport,arrivalAirportCode:H.arrivalCode,arrivalTime:H.arrivalTime},underName:{"@type":"http://schema.org/Person",name:U.name,email:U.email},checkinUrl:i,reservationId:H.reservationId,reservationStatus:"http://schema.org/Reservation"+(T||"Confirmed"),totalPrice:U.totalPrice,priceCurrency:U.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:U.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:U.seats[H.flightNumber],seatingType:U.seatingType[H.flightNumber]}}};valid(U.membershipNumber,U.programName)&&(Z.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:U.membershipNumber,programName:U.programName}),G.push(Z)}return G.length?G:void 0}}).call();
