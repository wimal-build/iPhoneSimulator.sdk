// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,t,r){if(!e||!t||!r)return CONTINUE;r.templateHeader=r.templateHeader||[];var a=Scanner.fromMessage(e);a.setLocale(t);for(var n,i,o,s,p,l,d,m,g,h,c,u,T,f,v,x,y,C,b,k,N,A,F,S,R,U,E,I,P,z,L,$,D,O=[],H=[],M={},Z=[],j=[],w=a.getSpan(),B=0,q=r.emailHeader.length;q>B;B++)w=w.nextText(r.emailHeader[B]);if(w.parentAnyTag("table").exists()){if(n=a.getSpan().nextText(r.mainContact).parentTag("td11").tagContents().innerCapture(regExpFormatted(/\b\1 (.*)/,r.mainContact),1),o=n.nextText(r.emailAddress).nextTag("td13").tagContents(),a.getSpan().nextText(r.flight.verify).exists()){if(i=a.getSpan().nextRegExp(r.flight.travelers).nextTag("table13").allInnerTags("tr13").map(function(e){return e.allInnerTagsFiltered("td13")}),!i.length&&n&&i.push([a.getNullSpan(),n]),i.length)for(var G=0;i.length>G;G++)M[""+i[G][1]]={name:i[G][1],seats:{},seatingType:{}};for(l=a.getSpan().nextRegExp(r.flight.checkinUrl).nextLink(),g=a.getSpan().nextText(r.flight.details);g.nextTag("table12").exists();)if(g=g.nextTag("table12"),s=g.allInnerTagsFiltered("td12"),!(!s.length>=2)){h=s[0];for(var B=1;s.length>B&&(p=s[B].innerCapture(regExpFormatted(/\b\1 (\w+)/,r.confirmationCode),1),!valid(p));B++);if(g=g.nextTag("table11"),s=g.allInnerTagsFiltered("td11"),!(!s.length>=7)){if(T=s[0].innerCapture(regExpFormatted(/^\1 .* \(([A-Z]{3})\)/,r.flight.depart),1),v=s[1].innerCapture(regExpFormatted(/^\1 .* \(([A-Z]{3})\)/,r.flight.arrive),1),u=combineDateAndTime(s[4],s[2]),f=combineDateAndTime(s[5],s[3]),c=s[6].innerCapture(regExpFormatted(/\b\1 (\d+)/,r.flight.flightNumber),1),g=g.nextTag("table11").nextTag("table11"),s=g.allInnerTagsFiltered("td11"),s.length){if(d=s[0].innerCapture(/^($<list>.*), ($<type>.*?), .*$/),valid(c,d)){m=d.$list,m=not(m)||m.innerCapture(regExpFormatted(/^\1/,r.flight.seatUnassigned))?[]:m.split(",").map(function(e){return e.trim()});var J=d.$type;i=Object.keys(M);for(var G=0;i.length>G;G++)valid(m[G])&&(M[""+i[G]].seats[""+c]=m[G]),valid(J)&&(M[""+i[G]].seatingType[""+c]=J)}m=d?d.$list.innerCapture(/(\d+[A-Z])/,1):null}ASSERT(h,c,T,u,f,v)&&H.push({airlineName:h,flightNumber:c,departureCode:T,departureTime:u,arrivalCode:v,arrivalTime:f,reservationId:p,checkinUrl:l,passengers:M})}}}a.getSpan().nextText(r.hotel.verify).exists()&&(x=a.getSpan().nextText(r.hotel.verify).previousText(r.hotel.checkin).nextDate(),y=x.nextText(r.hotel.checkout).nextDate(),p=y.nextText(r.confirmationCode).parentAnyTag("td").tagContents().innerCapture(regExpFormatted(/\b\1\s+(\w+)$/,r.confirmationCode),1),s=x.previousTag("table10"),A=s.innerText(r.hotel.modify).parentAnyTag("td").tagContents().innerCapture(regExpFormatted(/\b\1 <(.*?)>/,r.hotel.modify),1),F=A,s=s.innerTag("td10").tagContents().innerCapture(/\b($<name>.*?) <($<url>.*)>/),b=s?s.$name:null,C=s?s.$url:null,s=y.nextText(r.hotel.address).parentAnyTag("td").tagContents(),N=s.innerCapture(regExpFormatted(/\b\1\s+(.*)/,r.hotel.address),1),s.innerAddress().getLength()>N.getLength()&&(N=s.innerAddress()),s=s.nextText(r.hotel.telephone).parentAnyTag("td").tagContents(),k=s.innerCapture(regExpFormatted(/\b\1\s+([-\d)( ]+)/,r.hotel.telephone),1),s.innerPhoneNumber().getLength()>k.getLength()&&(k=s.innerPhoneNumber()),ASSERT(b,N,x,y)&&Z.push({name:n,email:o,hotelName:b,hotelAddress:N,hotelUrl:C,hotelPhone:k,checkInDateTime:x,checkOutDateTime:y,reservationId:p,modifyReservationUrl:A,cancelReservationUrl:F})),a.getSpan().nextText(r.car.verify).exists()&&(z=a.getSpan().nextText(r.car.verify).previousText(r.car.pickup).parentAnyTag("td").tagContents(),D=getFuzzyDate(z),L=z.innerCapture(regExpFormatted(/\s\1 (.*)\s/,r.car.address),1),$=z.innerPhoneNumber(),U=z.nextText(r.car.dropoff).parentAnyTag("td").tagContents(),P=getFuzzyDate(U),E=U.innerCapture(regExpFormatted(/\s\1 (.*)\s/,r.car.address),1)||L,I=U.innerPhoneNumber().result()||$,s=z.previousText(r.confirmationCode).parentTag("table10").allInnerTagsFiltered("td10"),s.length&&(R=s[0],p=s[1].innerCapture(regExpFormatted(/\b\1 (.*)/,r.confirmationCode),1),s=z.previousText(r.confirmationCode).previousTag("table8"),S=s.nextTag("td8").tagContents(),A=s.innerText(r.car.modify).nextLink(),F=A),ASSERT(D,L,R,p)&&j.push({name:n,email:o,brand:S,pickupTime:D,pickupAddress:L,pickupTelephone:$,dropoffTime:P,dropoffAddress:E,dropoffTelephone:I,provider:R,reservationId:p,modifyReservationUrl:A,cancelReservationUrl:F}))}for(var K,Q,B=0;H.length>B;B++){Q=H[B];for(var V=Object.keys(Q.passengers),W=0;V.length>W;W++){var X=Q.passengers[V[W]];K={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:Q.airlineName,airlineCode:Q.airlineCode,flightNumber:Q.flightNumber,departureAirportFuzzy:Q.departureAirport,departureAirportCode:Q.departureCode,departureTime:Q.departureTime,arrivalAirportFuzzy:Q.arrivalAirport,arrivalAirportCode:Q.arrivalCode,arrivalTime:Q.arrivalTime},underName:{"@type":"http://schema.org/Person",name:X.name},checkinUrl:Q.checkinUrl,reservationId:Q.reservationId,reservationStatus:"http://schema.org/Reservation"+(Q.reservationStatus||"Confirmed"),totalPrice:X.price,priceCurrency:X.currency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:X.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:X.seats[Q.flightNumber],seatingType:X.seatingType[Q.flightNumber]}}},valid(X.membershipNumber,X.programName)&&(K.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:X.membershipNumber,programName:X.programName}),O.push(K)}}for(var Y,B=0;j.length>B;B++)Y=j[B],K={"@context":"http://schema.org","@type":"http://schema.org/RentalCarReservation",totalPrice:Y.totalPrice,priceCurrency:Y.priceCurrency,reservationId:Y.reservationId,reservationStatus:"http://schema.org/Reservation"+(Y.reservationStatus||"Confirmed"),checkinUrl:Y.checkinUrl,modifyReservationUrl:Y.modifyReservationUrl,cancelReservationUrl:Y.cancelReservationUrl,underName:{"@type":"http://schema.org/Person",name:Y.name,email:Y.email},provider:{"@type":"http://schema.org/Organization",name:Y.provider},pickupTime:Y.pickupTime,pickupLocation:{"@type":"http://schema.org/Place",name:Y.pickupName,telephone:Y.pickupTelephone,address:Y.pickupAddress},dropoffTime:Y.dropoffTime,dropoffLocation:{"@type":"http://schema.org/Place",name:Y.dropoffName,telephone:Y.dropoffTelephone,address:Y.dropoffAddress}},Y.brand&&(K.reservationFor={"@type":"http://schema.org/Car",brand:{"@type":"http://schema.org/Organization",name:Y.brand},license:Y.license,color:Y.color}),O.push(K);for(var _,B=0;Z.length>B;B++)_=Z[B],K={"@context":"http://schema.org","@type":"http://schema.org/LodgingReservation",underName:{"@type":"http://schema.org/Person",name:_.name,email:_.email},totalPrice:_.totalPrice,priceCurrency:_.priceCurrency,checkinTime:_.checkInDateTime,checkoutTime:_.checkOutDateTime,modifyReservationUrl:_.modifyReservationUrl,cancelReservationUrl:_.cancelReservationUrl,reservationStatus:"http://schema.org/Reservation"+(_.reservationStatus||"Confirmed"),reservationId:_.reservationId,reservationFor:{"@type":"http://schema.org/LodgingBusiness",name:_.hotelName,url:_.hotelUrl,telephone:_.hotelPhone,address:_.hotelAddress}},O.push(K);return O.length?O:void 0}}).call();
