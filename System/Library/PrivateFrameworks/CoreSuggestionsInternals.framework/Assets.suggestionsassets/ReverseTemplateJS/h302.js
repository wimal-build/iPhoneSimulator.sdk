// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,t,r){if(!e||!t||!r)return CONTINUE;var a=Scanner.fromMessage(e);a.setLocale(t);var n,i,o,p,s,d,l,g,m,c,h,u,v,T,x,f,y,C,A,b,S,N,k,F,P,R,I,E,D,U,$,z,L=[],O=[],M={},j=[],Z=[];if(l=a.getSpan().innerCapture(regExpFormatted(/\b\1 (\d+)/,r.reservationId),1),S=a.getSpan().nextText(r.totalPrice).nextTag("td8").tagContents(),s=S.innerCapture(/([\d,.]+)/,1),d=S.innerCapture(/([^\d,.]+)/,1),a.getSpan().nextRegExp(regExpFormatted(/\1/,r.flight.names)).exists()){i=a.getSpan().innerCapture(regExpFormatted(/\1 (.*)\s/,r.flight.names),1),i=i.split(", ");for(var B=0,q=i.length;q>B;B++)M[""+i[B]]={name:i[B],seats:{},seatingType:{},totalPrice:s,priceCurrency:d};if(Object.keys(M).length){p=a.getSpan().nextRegExp(regExpFormatted(/\1/,r.flight.names)).previousAnyTag("table"),o=p.getTagNumber(),p=p.nextTag("table"+o),p.innerText(r.taxes).exists()&&(p=p.nextTag("table"+o)),p=p.allInnerTags("tr"+o).map(function(e){return e.allInnerTagsFiltered("td"+o)}).filter(function(e){return e.length>=4});for(var B=0,q=p.length;q>B;B++)c=p[B],h=c[0].innerCapture(regExpFormatted(/($<departureAirport>.*) \(($<departureCode>[A-Z]{3})\) \1 ($<arrivalAirport>.*) \(($<arrivalCode>[A-Z]{3})\)/,r.flight.to)),h&&(f=h.$departureAirport,y=h.$departureCode,A=h.$arrivalAirport,b=h.$arrivalCode),m=c[1].innerDate(),g=a.getDateDD(c[2].innerDate()),g.endIso8601&&(x=combineDateAndTime(m,g.iso8601),C=combineDateAndTime(m,g.endIso8601)),u=c[3].innerCapture(/($<name>.*) ($<flightNumber>\d+)/),v=u?u.$name:null,T=u?u.$flightNumber:null,ASSERT(v,T,x,y,C,b)&&O.push({airlineName:v,flightNumber:T,reservationId:l,departureAirport:f,departureCode:y,departureTime:x,arrivalAirport:A,arrivalCode:b,arrivalTime:C,passengers:M})}}if(a.getSpan().nextText(r.hotel.name).exists()){n=a.getSpan().innerCapture(regExpFormatted(/\b\1 (.*) -/,r.hotel.name),1),not(s)&&(s=a.getSpan().nextText(r.hotel.totalPrice).nextTag("td8").tagContents().innerCapture(/([\d,.]+)/,1)),p=n.nextAnyTag("table"),o=p.getTagNumber(),p.innerText(r.taxes).exists()&&(p=p.nextTag("table"+o)),p=p.allInnerTagsFiltered("td"+o),F=p[0],R=s.nextTag("table7").innerAddress(),P=s.nextTag("table7").innerPhoneNumber();for(var w,G="",H=1;p.length>H;H++)if(p[H].innerCapture(regExpFormatted(/^\1/,r.hotel.telephone))){for(var J=H-1;J>0;J--)G=p[J]+"\n"+G;(not(R)||G.length>R.getLength())&&(R=G),w=p[H].innerCapture(regExpFormatted(/^\1 (.*)/,r.hotel.telephone),1),valid(w)&&(not(P)||valid(P)&&w.getLength()>P.getLength())&&(P=w)}else p[H].innerCapture(regExpFormatted(/^\1/,r.hotel.checkin))?N=p[H].innerDate():p[H].innerCapture(regExpFormatted(/^\1/,r.hotel.checkout))&&(k=p[H].innerDate());ASSERT(R,N,k)&&j.push({name:n,reservationId:l,totalPrice:s,hotelName:F,hotelAddress:R,hotelPhone:P,checkInDateTime:N,checkOutDateTime:k})}a.getSpan().nextText(r.car.name).exists()&&(n=a.getSpan().nextText(r.car.name).parentAnyTag("td").innerCapture(regExpFormatted(/\b\1 (.*)\s/,r.car.name),1),s=a.getSpan().nextText(r.car.totalPrice).nextAnyTag("td").tagContents().innerCapture(/([\d,.]+)/,1),E=a.getSpan().nextText(r.car.provider).parentAnyTag("td").tagContents().innerCapture(regExpFormatted(/\1 (.*?),/,r.car.provider),1),I=a.getSpan().nextText(r.car.totalPrice).nextTag("table7").allInnerTagsFiltered("td7")[0],z=getFuzzyDate(a.getSpan().next(r.car.pickup).parentAnyTag("td")),$=a.getSpan().next(r.car.pickup).parentAnyTag("td"),$=$.innerAddress().exists()?$.tagContents().innerCapture(/(.*)$/,1):n.parentAnyTag("td").innerAddress().exists()?n.parentAnyTag("td").innerAddress():null,U=getFuzzyDate(a.getSpan().next(r.car.dropoff).parentAnyTag("td")),D=a.getSpan().next(r.car.dropoff).parentAnyTag("td"),D=D.innerAddress().exists()?D.tagContents().innerCapture(/(.*)$/,1):n.parentAnyTag("td").innerAddress().exists()?n.parentAnyTag("td").innerAddress():null,ASSERT(n,z,E)&&Z.push({name:n,reservationId:l,totalPrice:s,pickupTime:z,pickupAddress:$,dropoffTime:U,dropoffAddress:D,brand:I,provider:E}));for(var K,Q,B=0;O.length>B;B++){Q=O[B];for(var V=Object.keys(Q.passengers),W=0;V.length>W;W++){var X=Q.passengers[V[W]];K={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:Q.airlineName,airlineCode:Q.airlineCode,flightNumber:Q.flightNumber,departureAirportFuzzy:Q.departureAirport,departureAirportCode:Q.departureCode,departureTime:Q.departureTime,arrivalAirportFuzzy:Q.arrivalAirport,arrivalAirportCode:Q.arrivalCode,arrivalTime:Q.arrivalTime},underName:{"@type":"http://schema.org/Person",name:X.name},checkinUrl:Q.checkinUrl,reservationId:Q.reservationId,reservationStatus:"http://schema.org/Reservation"+(Q.reservationStatus||"Confirmed"),totalPrice:X.totalPrice,priceCurrency:X.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:X.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:X.seats[Q.flightNumber],seatingType:X.seatingType[Q.flightNumber]}}},valid(X.membershipNumber,X.programName)&&(K.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:X.membershipNumber,programName:X.programName}),L.push(K)}}for(var Y,B=0;Z.length>B;B++)Y=Z[B],K={"@context":"http://schema.org","@type":"http://schema.org/RentalCarReservation",totalPrice:Y.totalPrice,priceCurrency:Y.priceCurrency,reservationId:Y.reservationId,reservationStatus:"http://schema.org/Reservation"+(Y.reservationStatus||"Confirmed"),checkinUrl:Y.checkinUrl,modifyReservationUrl:Y.modifyReservationUrl,cancelReservationUrl:Y.cancelReservationUrl,underName:{"@type":"http://schema.org/Person",name:Y.name,email:Y.email},provider:{"@type":"http://schema.org/Organization",name:Y.provider},pickupTime:Y.pickupTime,pickupLocation:{"@type":"http://schema.org/Place",name:Y.pickupName,telephone:Y.pickupTelephone,address:Y.pickupAddress},dropoffTime:Y.dropoffTime,dropoffLocation:{"@type":"http://schema.org/Place",name:Y.dropoffName,telephone:Y.dropoffTelephone,address:Y.dropoffAddress}},Y.brand&&(K.reservationFor={"@type":"http://schema.org/Car",brand:{"@type":"http://schema.org/Organization",name:Y.brand},license:Y.license,color:Y.color}),L.push(K);for(var _,B=0;j.length>B;B++)_=j[B],K={"@context":"http://schema.org","@type":"http://schema.org/LodgingReservation",underName:{"@type":"http://schema.org/Person",name:_.name,email:_.email},totalPrice:_.totalPrice,priceCurrency:_.priceCurrency,checkinTime:_.checkInDateTime,checkoutTime:_.checkOutDateTime,modifyReservationUrl:_.modifyReservationUrl,cancelReservationUrl:_.cancelReservationUrl,reservationStatus:"http://schema.org/Reservation"+(_.reservationStatus||"Confirmed"),reservationId:_.reservationId,reservationFor:{"@type":"http://schema.org/LodgingBusiness",name:_.hotelName,url:_.hotelUrl,telephone:_.hotelPhone,address:_.hotelAddress}},L.push(K);return L.length?L:void 0}}).call();