// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,r,t){var a=Scanner.fromMessage(e);a.setLocale(r);var i,n,p,m,o,l,s,g,h,u,d,c,v,f,T,N=[],b={};m=a.getSpan().innerCapture(/Dear ($<wholeName>(.*?)(?: and (.*))?),/);var S=m.$wholeName.trim(),x=""+a.getSpan().innerCapture(regExpFormatted(/\1 SkyMiles #($<membershipNumber>\d+)/,""+S),1);m=m.slice(2).filter(function(e){return valid(e)});for(var y,C=0;y=m[C++];)b[""+y.trim()]={name:""+y.trim(),membershipNumber:x,programName:"SkyMiles",seats:{},seatingType:{}};n=a.getSpan().innerCapture(/Delta Confirmation #(\w+)/,1),p=a.getSpan().innerCapture(/Your flight (?:.*) is available for check ?-?in <(.*)>/,1);for(var $=["One","Two","Three","Four","Five","Six","Seven","Eight"],D=0,A=a.getSpan().nextText("Flight Status"),k=function(e){e.innerText("UPGRADE").exists()&&(e=e.withStart(e.innerText("UPGRADE").getEnd()));var r=e.allInnerTags("table7").map(function(e){return e.allInnerTagsFiltered("td7")});if(r.length%3===0)for(var t=0,i=r.length/3;i>t;t++){if(o=r[3*t][0],s=r[3*t][1].innerCapture(/^($<airlineName>.*) ($<flightNumber>\d+)/),g=s?s.$airlineName:null,l=s?s.$flightNumber:null,u=r[3*t+1][0].innerCapture(/Departs ($<time>\d{1,2}:\d{2} (?:am|pm)) ($<airport>.*)/),u&&(d=a.getDetachedSpan(""+o+" "+u.$time).innerDate(),c=u.$airport),v=r[3*t+1][1].innerCapture(/Arrives ($<time>\d{1,2}:\d{2} (?:am|pm)) (?:\(($<nextDate>.*)\) )?($<airport>.*)/),v&&(f=a.getDetachedSpan((not(v.$nextDate)?""+o:""+v.$nextDate)+" "+v.$time),T=v.$airport),r[3*t+2].length){var n=r[3*t+2][0].innerCapture(/Seat ([\w,\s]+)/,1).trim();if(n){n=n.split(", ");for(var p,m=Object.keys(b),S=0;p=m[S];S++)b[p].seats[l]=n[S]}}h=/delta/gi.test(g)?"DL":null,ASSERT(h,g,l,c,d,T,f)&&N.push({airlineCode:h,airlineName:g,flightNumber:l,departureAirport:c,departureTime:d,arrivalAirport:T,arrivalTime:f,passengers:b})}};A.nextText("Trip "+$[D]).exists()&&$.length>D;)k(A.withEnd(A.nextText("Trip "+$[D]).getEnd())),A=A.nextText("Trip "+$[D]),D++;k(A.withEnd(a.getSpan().nextText("Thank you for choosing Delta.").getEnd()));for(var F=[],C=0;N.length>C;C++)for(var E=N[C],w=Object.keys(E.passengers),z=0;w.length>z;z++){var P=E.passengers[w[z]],M={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:E.airlineName,airlineCode:E.airlineCode,flightNumber:E.flightNumber,departureAirportFuzzy:E.departureAirport,departureAirportCode:E.departureCode,departureTime:E.departureTime,arrivalAirportFuzzy:E.arrivalAirport,arrivalAirportCode:E.arrivalCode,arrivalTime:E.arrivalTime},underName:{"@type":"http://schema.org/Person",name:P.name},checkinUrl:p,reservationId:n,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:P.totalPrice,priceCurrency:P.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:i,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:P.seats[E.flightNumber],seatingType:P.seatingType[E.flightNumber]}}};valid(P.membershipNumber,P.programName)&&(M.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:P.membershipNumber,programName:P.programName}),F.push(M)}return F.length?F:void 0}}).call();
