// Copyright 2014 Apple Inc.  All Rights Reserved.
new ReverseTemplateList([new ReverseTemplate("delta.com-checkin-or-upgrade-en",function(e){return/^It's Time To Check-In/i.test(e.subject)||/^Your upgrade is now confirmed/.test(e.subject)},function(e){if(/^It's Time To Check-In/i.test(e.subject)||/^Your upgrade is now confirmed/.test(e.subject)){var r=Scanner.fromMessage(e);r.setLocale("en_US");var t,a,i,n,p,m,s,o,l,g,u,h,d,c,v,b=[],T={};n=r.getSpan().innerCapture(/Dear ($<wholeName>(.*?)(?: and (.*))?),/);var N=n.$wholeName.trim(),f=""+r.getSpan().innerCapture(regExpFormatted(/\1 SkyMiles #($<membershipNumber>\d+)/,""+N),1);n=n.slice(2).filter(function(e){return valid(e)});for(var C,S=0;C=n[S++];)T[""+C.trim()]={name:""+C.trim(),membershipNumber:f,programName:"SkyMiles",seats:{},seatingType:{}};a=r.getSpan().innerCapture(/Delta Confirmation #(\w+)/,1),i=r.getSpan().innerCapture(/Your flight (?:.*) is available for check ?-?in <(.*)>/,1);for(var x=["One","Two","Three","Four","Five","Six","Seven","Eight"],y=0,A=r.getSpan().nextText("Flight Status"),$=function(e){e.innerText("UPGRADE").exists()&&(e=e.withStart(e.innerText("UPGRADE").getEnd()));var t=e.allInnerTags("table7").map(function(e){return e.allInnerTagsFiltered("td7")});if(t.length%3===0)for(var a=0,i=t.length/3;i>a;a++){if(p=t[3*a][0],s=t[3*a][1].innerCapture(/^($<airlineName>.*) ($<flightNumber>\d+)/),o=s?s.$airlineName:null,m=s?s.$flightNumber:null,g=t[3*a+1][0].innerCapture(/Departs ($<time>\d{1,2}:\d{2} (?:am|pm)) ($<airport>.*)/),g&&(u=r.getDetachedSpan(""+p+" "+g.$time).innerDate(),h=g.$airport),d=t[3*a+1][1].innerCapture(/Arrives ($<time>\d{1,2}:\d{2} (?:am|pm)) (?:\(($<nextDate>.*)\) )?($<airport>.*)/),d&&(c=r.getDetachedSpan((not(d.$nextDate)?""+p:""+d.$nextDate)+" "+d.$time),v=d.$airport),t[3*a+2].length){var n=t[3*a+2][0].innerCapture(/Seat ([\w,\s]+)/,1).trim();if(n){n=n.split(", ");for(var N,f=Object.keys(T),C=0;N=f[C];C++)T[N].seats[m]=n[C]}}l=/delta/gi.test(o)?"DL":null,ASSERT(l,o,m,h,u,v,c)&&b.push({airlineCode:l,airlineName:o,flightNumber:m,departureAirport:h,departureTime:u,arrivalAirport:v,arrivalTime:c,passengers:T})}};A.nextText("Trip "+x[y]).exists()&&x.length>y;)$(A.withEnd(A.nextText("Trip "+x[y]).getEnd())),A=A.nextText("Trip "+x[y]),y++;$(A.withEnd(r.getSpan().nextText("Thank you for choosing Delta.").getEnd()));for(var D=[],S=0;b.length>S;S++)for(var E=b[S],k=Object.keys(E.passengers),F=0;k.length>F;F++){var R=E.passengers[k[F]],P={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:E.airlineName,airlineCode:E.airlineCode,flightNumber:E.flightNumber,departureAirportFuzzy:E.departureAirport,departureAirportCode:E.departureCode,departureTime:E.departureTime,arrivalAirportFuzzy:E.arrivalAirport,arrivalAirportCode:E.arrivalCode,arrivalTime:E.arrivalTime},underName:{"@type":"http://schema.org/Person",name:R.name},checkinUrl:i,reservationId:a,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:R.totalPrice,priceCurrency:R.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:t,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:R.seats[E.flightNumber],seatingType:R.seatingType[E.flightNumber]}}};valid(R.membershipNumber,R.programName)&&(P.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:R.membershipNumber,programName:R.programName}),D.push(P)}if(D.length)return D}},"0/1/2/3/4/5/3/5/6/6/6/6/4/7/112/197/198","SGcfe08655"),new ReverseTemplate("delta.com-itinerary-receipt-en",function(e){var r=Scanner.fromMessage({plain:e.subject});return r.setLocale("en_US"),r.getSpan().innerDate().exists()||/^Delta Reservation Itinerary/.test(e.subject)},function(e){var r=Scanner.fromMessage(e);if(r.setLocale("en_US"),r.getSpan().nextRegExp(/YOUR ITINERARY AND (?:RECEIPT|PASSENGER DETAILS)/).exists()){var t,a,i,n,p,m,s,o,l,g,u,h=[],d={};if(a=r.getSpan().innerCapture(/\bFlight Confirmation #: (\S+)/,1),i=a.parentTag("table4").withStart(a.getStart()).innerLink(),t=r.getSpan().innerCapture(/\bTicket #: (\d+)/,1),not(a)&&(a=r.getSpan().innerCapture(/\bYour Delta Confirmation #: (\S+)/,1)),g=r.getSpan().nextText("Passenger Details").nextTag("table5").tagContents().innerCapture(/\b($<name>.*)\s?(?:\bSkyMiles #($<membershipNumber>.*?)($<programName>\s?[A-z]*?) <)?/)){n=g.$name.trim(),n.innerCapture(/.*? </)&&(n=n.innerCapture(/(.*?) </,1));var c=""+n;d[c]={name:n,programName:g.$programName.exists()?"SkyMiles"+g.$programName:"",membershipNumber:""+g.$membershipNumber,seats:{},seatingType:{}};var v=r.getSpan().nextText("Passenger Details").nextTag("table6").allInnerTagsFiltered("td6");if(v.length&&v.length%2===0)for(var b=0,T=v.length/2;T>b;b++)/(?:See delta\.com|Not Assigned)/.test(v[2*b+1])||(o=""+v[2*b].innerCapture(/([\d]+)/,1),p=v[2*b+1].innerCapture(/(\d+[A-Z])/,1),d[c].seats[""+o]=p);l=r.getSpan().nextRegExp(/\b(?:Ticket Amount|Total):/).nextTag("td4").tagContents().innerCapture(/($<totalPrice>[\d,.]+)\s?($<priceCurrency>[A-Z]{3})?/),l&&(d[c].totalPrice=l.$totalPrice,d[c].priceCurrency=l.$priceCurrency)}s=r.getSpan().nextText("Your Flight Information").nextTag("table4").allInnerTagsFiltered("td4");for(var N,f,C,S,x=/\b($<date>(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun) \d{2}(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC))/,y=/\b($<type>LV|AR) ($<time>\d{1,2}:\d{2}(?:am|pm|N))/,A=/\b($<airlineName>.*) ($<flightNumber>[\d]+)/,$={},D={},b=0;f=s[b++];)if(f.innerCapture(y)){if(C=f.innerCapture(y),N=""+C.$type=="LV"?"departure":"arrival",f.innerCapture(x)&&(m=f.innerCapture(x,1)),valid(m,C.$time)){var E=""+C.$time;"12:00N"===E&&(E="12:00pm"),S=r.getDetachedSpan(""+m+" "+E),$[N+"Time"]=S.innerDate()}}else f.innerCapture(x)?m=f.innerCapture(x,1):f.innerCapture(A)?(u=f.innerCapture(A),u&&($.airlineName=u.$airlineName,$.flightNumber=u.$flightNumber,$.airlineCode=/delta/gi.test($.airlineName)?"DL":null),ASSERT($.departureTime,$.arrivalTime,$.departureAirport,$.arrivalAirport,$.airlineName,$.flightNumber)&&(D[""+$.airlineName]=!0,$.passengers=d,h.push($)),$={}):N&&($[N+"Airport"]=""+f,N=null);var k=[],F=r.getSpan().nextText("Baggage Fees"),R=F.nextRegExp(/1[:)]On Delta[- ]operated flights/).previousTag("table4").collapseToEnd();R.exists()&&(F=F.withEnd(R.getStart()));for(var C,P=F.allInnerDates(),I=function(e){return 3===(""+e).length?e:""},b=0;P.length>b;b++)for(var w,M=P[b],z=P[b+1]||R,S=M.super(z),U=S.allInnerTagsFiltered("td5"),L=0;w=U[L];L++)D[w]&&U.length>L+2&&k.push([I(U[L+1]),I(U[L+2])]);if(k.length===h.length)for(var b=0,T=h.length;T>b;b++)h[b].departureCode=k[b][0],h[b].arrivalCode=k[b][1];for(var j=[],b=0;h.length>b;b++){var $=h[b];ASSERT(OR($.airlineCode,AND($.departureCode,$.arrivalCode)));for(var O=Object.keys($.passengers),L=0;O.length>L;L++){var Y=$.passengers[O[L]],G={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:$.airlineName,airlineCode:$.airlineCode,flightNumber:$.flightNumber,departureAirportFuzzy:$.departureAirport,departureAirportCode:$.departureCode,departureTime:$.departureTime,arrivalAirportFuzzy:$.arrivalAirport,arrivalAirportCode:$.arrivalCode,arrivalTime:$.arrivalTime},underName:{"@type":"http://schema.org/Person",name:Y.name},checkinUrl:i,reservationId:a,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:Y.totalPrice,priceCurrency:Y.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:t,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:Y.seats[$.flightNumber],seatingType:Y.seatingType[$.flightNumber]}}};valid(Y.membershipNumber,Y.programName)&&(G.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:Y.membershipNumber,programName:Y.programName}),j.push(G)}}if(j.length)return j}},"0/1/2/3/4/5/3/5/6/6/6/6/4/7/112/197/201","SG0d1528be")]);