// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,t){var r=Scanner.fromMessage(e);r.setLocale(t);var a,n,i,p,o,m,s,g,l,u,d,c,h,T,C,f,v,y,b=[],x={};a=r.getSpan().nextRegExp(/[Cc]onfirmation code:/).parentAnyTag("td").tagContents().innerCapture(/\b[Cc]onfirmation code:\s+(\w+)/,1),not(a)&&(a=r.getSpan().nextRegExp(/Confirmation code:/).nextAnyTag("td").tagContents()),p=r.getSpan().nextText("Passenger name").parentTag("table3").withStart(r.getSpan().nextText("Passenger name").getEnd()).allInnerTags("tr3"),l=r.getSpan().nextText("Total fare").nextTag("td3").tagContents().innerCapture(/([\d,.]+)/,1),not(l)&&(d=r.getSpan().nextText("Fare total").nextTag("td4").tagContents().innerCapture(/($<total>[\d,.]+)\s+($<currency>[\w]+)/),l=d?d.$total:null,u=d?d.$currency:null);for(var N=0,S=p.length;S>N;N++)c=p[N].allInnerTags("td3").map(function(e){return e.tagContents()}),i=""+c[0],x[i]={name:i,programName:"Frequent Flyer",membershipNumber:c[1],ticketNumber:c[2],seats:{},seatingType:{},totalPrice:l,priceCurrency:u};s=r.getSpan().nextText("Trip details").parentTag("table3").allInnerTags("tr3").map(function(e){return e.allInnerTags("td3").map(function(e){return e.tagContents()})}).filter(function(e){return e.length>0});for(var A,$=/^($<time>\d{1,2}:\d{2} [A|P]M)\s+($<code>[A-Z]{3})$/,F=/Flight # (\d+) : Arrives next day,/,k=0;s.length>k;k++)if(c=s[k],c[0].innerCapture(/^(?:Depart|Return)/))m=c[0].nextText("Date:").nextDate();else if(c[1]&&c[1].innerCapture($)){g=c[0],h=c[1].innerCapture($),T=r.getDetachedSpan(""+m+" "+h.$time).innerDate(),C=h.$code,f=c[2].innerCapture($),v=r.getDetachedSpan(""+m+" "+f.$time).innerDate(),y=f.$code;var D=c[c.length-2];o=c[c.length-1].split(" "),p=Object.keys(x);for(var N=0;N<Math.min(p.length,o.length);N++)x[p[N]].seats[g]=o[N].trim(),x[p[N]].seatingType[g]=D;ASSERT(g,T,C,v,y)&&b.push({airlineCode:"US",flightNumber:g,reservationId:a,departureCode:C,departureTime:T,arrivalCode:y,arrivalTime:v,passengers:x})}else if(c[0].innerCapture(F)){A=c[0].innerCapture(F,1);for(var P=b.length;P-->0&&(b[P].arrivalTime=modifyDate(b[P].arrivalTime,1),""+b[P].flightNumber!=""+A);)b[P].departureTime=modifyDate(b[P].departureTime,1)}for(var z=[],k=0;b.length>k;k++)for(var I=b[k],R=Object.keys(I.passengers),M=0;R.length>M;M++){var E=I.passengers[R[M]],w={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:I.airlineName,airlineCode:I.airlineCode,flightNumber:I.flightNumber,departureAirportFuzzy:I.departureAirport,departureAirportCode:I.departureCode,departureTime:I.departureTime,arrivalAirportFuzzy:I.arrivalAirport,arrivalAirportCode:I.arrivalCode,arrivalTime:I.arrivalTime},underName:{"@type":"http://schema.org/Person",name:E.name,email:E.email},checkinUrl:n,reservationId:a,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:E.totalPrice,priceCurrency:E.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:E.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:E.seats[I.flightNumber],seatingType:E.seatingType[I.flightNumber]}}};valid(E.membershipNumber,E.programName)&&(w.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:E.membershipNumber,programName:E.programName}),z.push(w)}return z.length?z:void 0}}).call();