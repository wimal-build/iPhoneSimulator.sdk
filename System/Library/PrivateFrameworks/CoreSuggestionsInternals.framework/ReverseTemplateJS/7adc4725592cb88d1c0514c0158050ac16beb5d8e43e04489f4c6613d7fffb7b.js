// Copyright 2014 Apple Inc.  All Rights Reserved.
new ReverseTemplateList([new ReverseTemplate("cathaypacific.com-itinerary-en",function(e){return/^YOUR ITINERARY:/.test(e.subject)},function(e){if(/^YOUR ITINERARY:/.test(e.subject)){var r=Scanner.fromMessage(e);r.setLocale("en_US");var t,a,i,n,s,p,o,m,l,d,u,g,c,T,h,A,v=[],E={},N=/BOOKING REF : .*?: \w{6}, AIRLINE: ($<airline>\w{2})\/($<reservationId>\w{6})/,R={};for(m=r.getSpan();m.nextRegExp(N).exists();)A=m.innerCapture(N),R[""+A.$airline]=A.$reservationId,m=m.withStart(A[0].getEnd());t=r.getSpan().innerCapture(/TICKET NUMBER\s+: ETKT ([\d ]+)/,1),o=r.getSpan().innerCapture(/TOTAL\s+: ($<priceCurrency>[A-Z]{3})\s+($<totalPrice>[\d,.]+)/);var $=o?o.$priceCurrency:null,b=o?o.$totalPrice:null;if(n=r.getSpan().innerCapture(/NAME: (.*)\s/,1),not(n))return CONTINUE;E[""+n]={name:n,seats:{},seatingType:{},ticketNumber:t,totalPrice:b,priceCurrency:$},s=r.getSpan().nextText("FROM /TO").nextText("FLIGHT").nextText("FARE BASIS").nextText("BAG  ST").collapseToEnd().withEnd(r.getSpan().nextText("AT CHECK-IN,").getStart()).trim().split("\r\n\r\n"),departureRegex=/($<airport>.*?)\s+($<airlineCode>[A-Z]{2}) ($<flightNumber>\d+)\s+.*?\s+($<date>\d{2}[A-Z]{3})\s+($<time>\d{4}).*\s/,arrivalRegex=/($<airport>.*?)\s+(?:SEAT: ($<seat>.*?))?\s+ARRIVAL TIME: ($<time>\d{4})\s+ARRIVAL DATE: ($<date>\d{2}[A-Z]{3})/;for(var C=0;s.length>C;C++)if(d=s[C].innerCapture(departureRegex),c=s[C].innerCapture(arrivalRegex),d&&c){for(var I=d[0].collapseToEnd().withEnd(c[0].getStart()).trim().split("\r\n"),f=[""+d.$airport.trim()],S=0;I.length>S;S++)/^\s*(TERMINAL|FLIGHT OPERATED BY)/.test(""+I[S])||f.push(""+I[S]);for(var y=c[0].collapseToEnd().withEnd(s[C].getEnd()).trim().split("\r\n"),x=[""+c.$airport.trim()],S=0;y.length>S;S++)/^\s*(TERMINAL|FLIGHT OPERATED BY)/.test(""+y[S])||x.push(""+y[S]);l=d.$airlineCode,p=d.$flightNumber,g=f.join(" "),u=combineDateAndTime(d.$date,d.$time),h=x.join(" "),T=combineDateAndTime(c.$date,c.$time),valid(c.$seat)&&(E[""+n].seats[""+p]=c.$seat),a=R[""+l],ASSERT(a,l,p,g,u,h,T)&&v.push({reservationId:a,airlineCode:l,flightNumber:p,departureAirport:g,departureTime:u,arrivalAirport:h,arrivalTime:T,passengers:E})}for(var F=[],C=0;v.length>C;C++)for(var L=v[C],O=Object.keys(L.passengers),w=0;O.length>w;w++){var M=L.passengers[O[w]],P={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:L.airlineName,airlineCode:L.airlineCode,flightNumber:L.flightNumber,departureAirportFuzzy:L.departureAirport,departureAirportCode:L.departureCode,departureTime:L.departureTime,arrivalAirportFuzzy:L.arrivalAirport,arrivalAirportCode:L.arrivalCode,arrivalTime:L.arrivalTime},underName:{"@type":"http://schema.org/Person",name:M.name},checkinUrl:i,reservationId:L.reservationId,reservationStatus:"http://schema.org/ReservationConfirmed",totalPrice:M.totalPrice,priceCurrency:M.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:t,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:M.seats[L.flightNumber],seatingType:M.seatingType[L.flightNumber]}}};valid(M.membershipNumber,M.programName)&&(P.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:M.membershipNumber,programName:M.programName}),F.push(P)}if(F.length)return F}},"0/1/2/3/4/5/3/5/6/6/6/6/4/7/112/187/196","SG149bebf4")]);