// Copyright 2014 Apple Inc.  All Rights Reserved.
new ReverseTemplateList([new ReverseTemplate("cheaptickets.com-itinerary-en",function(e){return/^Flight Confirmation/.test(e.subject)||/^Prepare for your trip/.test(e.subject)||/^Your Flight Reservation Changed/.test(e.subject)},function(e){function r(){$?$=!1:ASSERT(h,m,f,u,C,T)&&(A.push({startOfLeg:b,airlineName:h,flightNumber:m,reservationId:o,departureAirport:d,departureCode:f,departureTime:u,arrivalAirport:y,arrivalCode:C,arrivalTime:T,passengers:P}),c=h=m=g=d=f=u=v=y=C=T=s=seatingType=b=null)}if(int(e.epoch)<1356998400)return CONTINUE;var t=Scanner.fromMessage(e);t.setLocale("en_US");var a,n,i,o,s,p,l,m,c,h,g,u,d,f,v,T,y,C,b,N,k,S,R=[],A=[],P={},U=[],x=[];if(/^Flight Confirmation/.test(e.subject)||/^Prepare for your trip/.test(e.subject)||/^Your Flight Reservation Changed/.test(e.subject)){if(a=t.getSpan().nextText("Traveler information").withEnd(t.getSpan().nextText("Flight itinerary").getStart()).allInnerTags("table4"),i=t.getSpan().nextText("Total due at booking").nextTag("td4").tagContents().innerCapture(/([\d,.]+)/,1),a.length)for(var D=0;a.length>D;D++)if(passenger=a[D].allInnerTags("tr4"),passenger.length){currentName=null;for(var N,k,F=0;passenger.length>F;F++)N=passenger[F].innerTag("th4").tagContents(),k=passenger[F].innerTag("td4").tagContents(),N.innerCapture(/^Traveler/)?(currentName=""+k,P[currentName]={name:currentName,totalPrice:i,seats:{},seatingType:{}}):N.innerCapture(/^Airline Ticket Number:/)&&(P[currentName].ticketNumber=k.innerCapture(/(\d+)\s/,1))}o=t.getSpan().innerCapture(/\bCheapTickets record locator: (.*)\s/,1),l=t.getSpan().nextText("Flight itinerary").nextTag("table5").allInnerTags("tr5");var $=!0;if(l.length){p=null;for(var D=0;l.length>D;D++)if(n=l[D].allInnerTags("td5").map(function(e){return e.tagContents()}),n[0].innerCapture(/^Flight \d/)&&n[1]&&n[1].innerDate().exists())b=!0,p=n[1].innerDate();else if(n[0].innerCapture(/^Depart/)){if(r(),c=n[3].innerCapture(/($<name>.*?) ($<flightNumber>\d+)\s+($<seatingType>.*?) \|/),h=c?c.$name:null,m=c?c.$flightNumber:null,seatingType=c?c.$seatingType:null,a=Object.keys(P),valid(m,seatingType))for(var F=0;a.length>F;F++)P[a[F]].seatingType[m]=seatingType}else if(n[0].innerDate().exists())not(u)?(u=combineDateAndTime(p,n[0].innerDate()),g=n[1].innerCapture(/($<airport>.*?) \(($<code>[A-Z]{3})\)/),d=g?g.$airport:null,f=g?g.$code:null):(T=combineDateAndTime(p,n[0].innerDate()),v=n[1].innerCapture(/($<airport>.*?) \(($<code>[A-Z]{3})\)/),y=v?v.$airport:null,C=v?v.$code:null);else if(n[0].innerCapture(/^Seats:/)){s=n[0].innerCapture(/^Seats: (.*?) \|/,1),s&&(s=s.split(",").map(function(e){return e.trim()})),a=Object.keys(P);for(var F=0;F<Math.min(s.length,a.length);F++)P[a[F]].seats[m]=s[F],P[a[F]].seatingType[m]=seatingType}else if(n[0].innerCapture(/[Oo]vernight flight/)){if(T>u){u=modifyDate(u,1);for(var I,F=A.length-1;F>=0;F--){if(I=A[F],!(I.arrivalTime>I.departureTime)){I.arrivalTime=modifyDate(I.arrivalTime,1);break}if(I.startOfLeg||(I.departureTime=modifyDate(I.departureTime,1)),I.arrivalTime=modifyDate(I.arrivalTime,1),I.startOfLeg)break}}T=modifyDate(T,1)}r()}}for(var D=0;A.length>D;D++)for(var O=A[D],j=Object.keys(O.passengers),F=0;j.length>F;F++){var L=O.passengers[j[F]];schema={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:O.airlineName,airlineCode:O.airlineCode,flightNumber:O.flightNumber,departureAirportFuzzy:O.departureAirport,departureAirportCode:O.departureCode,departureTime:O.departureTime,arrivalAirportFuzzy:O.arrivalAirport,arrivalAirportCode:O.arrivalCode,arrivalTime:O.arrivalTime},underName:{"@type":"http://schema.org/Person",name:L.name},checkinUrl:O.checkinUrl,reservationId:O.reservationId,reservationStatus:"http://schema.org/Reservation"+(O.reservationStatus||"Confirmed"),reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:L.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:L.seats[O.flightNumber],seatingType:L.seatingType[O.flightNumber]}},totalPrice:L.totalPrice,priceCurrency:L.currency},not(L.membershipNumber)||(schema.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:L.membershipNumber,programName:L.programName}),R.push(schema)}for(var z,D=0;x.length>D;D++)z=x[D],schema={"@context":"http://schema.org","@type":"http://schema.org/RentalCarReservation",totalPrice:z.totalPrice,priceCurrency:z.priceCurrency,reservationId:z.reservationId,reservationStatus:"http://schema.org/Reservation"+(z.reservationStatus||"Confirmed"),checkinUrl:z.checkinUrl,modifyReservationUrl:z.modifyReservationUrl,cancelReservationUrl:z.cancelReservationUrl,underName:{"@type":"http://schema.org/Person",name:z.name,email:z.email},provider:{"@type":"http://schema.org/Organization",name:z.provider},pickupTime:z.pickupTime,pickupLocation:{"@type":"http://schema.org/Place",name:z.pickupName,telephone:z.pickupTelephone,address:z.pickupAddress},dropoffTime:z.dropoffTime,dropoffLocation:{"@type":"http://schema.org/Place",name:z.dropoffName,telephone:z.dropoffTelephone,address:z.dropoffAddress}},z.brand&&(schema.reservationFor={"@type":"http://schema.org/Car",brand:{"@type":"http://schema.org/Organization",name:z.brand},license:z.license,color:z.color}),R.push(schema);for(var S,D=0;U.length>D;D++)S=U[D],schema={"@context":"http://schema.org","@type":"http://schema.org/LodgingReservation",underName:{"@type":"http://schema.org/Person",name:S.name,email:S.email},totalPrice:S.totalPrice,priceCurrency:S.priceCurrency,checkinTime:S.checkInDateTime,checkoutTime:S.checkOutDateTime,modifyReservationUrl:S.modifyReservationUrl,cancelReservationUrl:S.cancelReservationUrl,reservationStatus:"http://schema.org/Reservation"+(S.reservationStatus||"Confirmed"),reservationId:S.reservationId,reservationFor:{"@type":"http://schema.org/LodgingBusiness",name:S.hotelName,url:S.hotelUrl,telephone:S.hotelPhone,address:S.hotelAddress}},R.push(schema);return R},"0/1/2/3/4/5/3/5/6/6/6/6/4/7/535/543/544","SGff745855")]);