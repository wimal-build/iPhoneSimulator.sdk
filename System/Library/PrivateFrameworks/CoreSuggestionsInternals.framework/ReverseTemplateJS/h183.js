// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,r,t){if(!e||!r||!t)return CONTINUE;var a=Scanner.fromMessage(e);a.setLocale(r);var n,i,p,m,l,o,s,u,g,d,c,h,v,C,x,b,T,N,y,f,$,F,E=[],S={};if(i=a.getSpan().nextRegExp(regExpFormatted(/\1/,t.travellers)).nextTag("table6").allInnerTags("tr6").map(function(e){return e.allInnerTagsFiltered("td6")}),!i.length)return CONTINUE;m=a.getSpan().nextText(t.priceSummary).nextText(t.totalPrice).parentTag("td5").tagContents(),l=m.innerCapture(regExpFormatted(/\b\1.*?([\d,.]+)/,t.totalPrice),1),o=l.nextTag("td5").tagContents().innerCapture(regExpFormatted(/\b\1 ([\w ]+)\.?/,t.priceCurrency),1),s=a.getSpan().innerCapture(regExpFormatted(/\b\1 (\d+)/,t.reservationId),1),a.getSpan().nextRegExp(regExpFormatted(/\1/,t.cancelled)).exists()&&(u="Cancelled");for(var k=0;i.length>k;k++)p=i[k],n=p[0].innerCapture(/(.*)\s/,1).trim(),x=p[1].innerCapture(regExpFormatted(/^\1/,t.noProgramName))?null:p[1].innerCapture(/($<name>.*) ($<number>\w+)/),C=p[2].innerCapture(regExpFormatted(/^\1 (\d+)/,t.ticketNumber),1),S[""+n]={name:n,totalPrice:l,priceCurrency:o,seats:{},seatingType:{},programName:x?x.$name:null,membershipNumber:x?x.$number:null,ticketNumber:C};v=a.getSpan().nextRegExp(regExpFormatted(/\1/,t.travellers));for(var I=/^($<code>[A-Z]{3})\s+($<time>\d{1,2}:\d{2}(?:am|pm)?)($<nextDay>\s+\+1)?/;v.nextText(t.totalTravelTime).exists();){v=v.nextText(t.totalTravelTime),c=v.previousTag("td5").innerDate(),v=v.nextTag("table6"),h=v.allInnerTagsFiltered("td6");for(var A,P,D,z=0;A=h[z];z++)if(A.innerCapture(I)&&h[z+1]&&h[z+1].innerCapture(I)&&h[z+3]){A=A.innerCapture(I),f=A.$code,y=a.getDetachedSpan(""+c+" "+A.$time).innerDate(),P=h[z+1].innerCapture(I),D=P.$nextDay,F=P.$code,$=a.getDetachedSpan(((""+D).length?""+h[z+1].lastInnerDate():""+c)+" "+P.$time),b=h[z+2].innerCapture(/($<name>.*)\s($<flightNumber>\d+)/),T=b?b.$name.trim():null,N=b?b.$flightNumber:null,g=h[z+3].innerCapture(/($<type>.*?) \| ($<list>[^|]+)/);var R=g?g.$type:null;if(d=g&&g.$list.innerCapture(regExpFormatted(/^\1/,t.seat))?g.$list.innerCapture(regExpFormatted(/^\1 (.*)/,t.seat),1).split(",").map(function(e){return e.trim()}):null,valid(N)){i=Object.keys(S);for(var k=0;i.length>k;k++)valid(d)&&(S[i[k]].seats[""+N]=d[k]),valid(R)&&(S[i[k]].seatingType[""+N]=R)}ASSERT(T,N,f,y,F,$)&&E.push({airlineName:T,flightNumber:N,reservationId:s,reservationStatus:u,departureCode:f,departureTime:y,arrivalCode:F,arrivalTime:$,passengers:S})}}for(var U,O=[],z=0;E.length>z;z++){U=E[z];for(var M=Object.keys(U.passengers),j=0;M.length>j;j++){var w=U.passengers[M[j]],L={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:U.airlineName,airlineCode:U.airlineCode,flightNumber:U.flightNumber,departureAirportFuzzy:U.departureAirport,departureAirportCode:U.departureCode,departureTime:U.departureTime,arrivalAirportFuzzy:U.arrivalAirport,arrivalAirportCode:U.arrivalCode,arrivalTime:U.arrivalTime},underName:{"@type":"http://schema.org/Person",name:w.name},checkinUrl:U.checkinUrl,reservationId:U.reservationId,reservationStatus:"http://schema.org/Reservation"+(U.reservationStatus||"Confirmed"),totalPrice:w.totalPrice,priceCurrency:w.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:w.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:w.seats[U.flightNumber],seatingType:w.seatingType[U.flightNumber]}}};valid(w.membershipNumber,w.programName)&&(L.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:w.membershipNumber,programName:w.programName}),O.push(L)}}return O.length?O:void 0}}).call();