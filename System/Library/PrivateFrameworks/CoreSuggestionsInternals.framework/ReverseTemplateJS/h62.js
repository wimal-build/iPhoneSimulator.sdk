// Copyright 2014 Apple Inc.  All Rights Reserved.
(function(){return function(e,t,r){function a(){return{reservationId:null,reservationStatus:null,totalPrice:null,priceCurrency:null}}function n(){return{checkinUrl:null,airlineCode:null,airlineName:null,flightNumber:null,departureAirportFuzzy:null,departureAirportCode:null,departureTime:null,arrivalAirportFuzzy:null,arrivalAirportCode:null,arrivalTime:null,seatingType:null}}function i(){return{name:null,email:null,telephone:null,membershipNumber:null,programName:null,ticketNumber:null}}function l(){return{seatNumber:null,seatingType:null}}function u(e){return e.tagContents().innerCapture(/.*, .* \((.*)\),[\s]?.*/,1)}function p(e){return e.tagContents().innerCapture(/(.*) \(.*\),[\s]?.*/,1).trim()}var o=a(),g=[],m=[],s=[],T="[A-Z]{2,3}",d="[0-9]{3,4}[a-zA-Z]?",x=Scanner.fromMessage(e),c=[];x.setLocale(t);for(var v=x.getSpan().nextText(r.travelTableTitle).nextTag("table4").nextText(r.flightTableTitle).parentTag("td5"),b=v.nextText(r.paymentTableTitle),h=b.nextText(r.passengerTableTitle).nextTag("table5"),C=h.nextTag("td6");C!==x.getNullSpan()&&h.contains(C);){var N=i();N.name=C.tagContents(),C=C.nextTag("td6").nextTag("td6");var y=C.innerCapture(RegExp(r.membershipLabel+"\\s*([A-Za-z ]*)\\s+([0-9]*)"));y&&null!==y[2]&&(N.membershipNumber=y[2].tagContents()),y&&null!==y[1]&&(N.programName=y[1].tagContents()),N.ticketNumber=C.innerCapture(regExpFormatted(/\s*\:\s*([\d|\s]+)/,r.ticketNumberLabel),1).trim(),m.push(N),r.extraPassengerSpacing&&(C=C.nextTag("table6").nextTag("table6").nextTag("table6").nextTag("table6").nextTag("td6").nextTag("td6").nextTag("td6")),C=C.nextTag("td6")}var z=h.nextText(r.preferencesTableTitle).nextTag("table5");o.totalPrice=x.getSpan().nextTag("table4").nextText(r.ticketPriceLabel).nextTag("td6").tagContents(),o.priceCurrency=o.totalPrice.nextTag("td6").tagContents(),o.reservationId=x.getSpan().nextText(r.reservationIdLabel).parentTag("td5").innerCapture(RegExp(r.reservationIdLabel+"\\s*([A-Za-z0-9]*)"),1).tagContents(),o.reservationStatus="http://schema.org/ReservationConfirmed";var f,A,S,F,k;for(f=v.nextTag("table6");f!==x.getNullSpan()&&v.contains(f);){var D=n();k=f.previousDate(),A=f.nextTag("td6"),F=A.innerCapture(RegExp(".*("+T+")\\s*("+d+").*-\\s+([^\\[]*)")),F&&(D.airlineCode=F[1],D.flightNumber=F[2],D.seatingType=F[3].trim());var P=A.nextTag("td6").nextDate();D.departureTime=getFuzzyDate(x.getDetachedSpan(""+k+" "+P));var I=P.nextTag("td6");D.departureAirportCode=u(I),D.departureAirportFuzzy=p(I);var R=I.nextTag("td6").nextTag("td6").nextTag("td6").nextTag("td6").nextTag("td6").nextDate();D.arrivalTime=getFuzzyDate(x.getDetachedSpan(""+k+" "+R)),unSpanDate_(D.departureTime)>unSpanDate_(D.arrivalTime)&&(D.arrivalTime=modifyDate(D.arrivalTime,1));var E=R.nextTag("td6");D.arrivalAirportCode=u(E),D.arrivalAirportFuzzy=p(E),ASSERT(D.airlineCode,D.flightNumber,D.arrivalTime,D.arrivalAirportCode,D.departureTime,D.departureAirportCode)&&g.push(D),f=f.nextTag("table6").nextTag("table6")}var L,U,Z=z;for(U=0;m.length>U;U++){Z=Z.nextTag("tr6");var M=[];for(L=0;g.length>L;L++){var O=l();Z=Z.nextTag("tr6");var _=Z.nextTag("td6").nextTag("td6").nextTag("td6").nextTag("td6").tagContents();""+_!="-"&&(O.seatNumber=_),M.push(O)}s.push(M),Z=Z.nextTag("tr6").nextTag("tr6")}for(L=0;g.length>L;L++){var D=g[L];for(U=0;m.length>U;U++){var j=m[U],S={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineCode:D.airlineCode,airlineName:D.airlineName,flightNumber:D.flightNumber,departureAirportFuzzy:D.departureAirportFuzzy,departureAirportCode:D.departureAirportCode,departureTime:D.departureTime,arrivalAirportFuzzy:D.arrivalAirportFuzzy,arrivalAirportCode:D.arrivalAirportCode,arrivalTime:D.arrivalTime},underName:{"@type":"http://schema.org/Person",name:j.name},checkinUrl:"",reservationId:o.reservationId,reservationStatus:o.reservationStatus,totalPrice:o.totalPrice,priceCurrency:o.priceCurrency,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:j.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:s[U][L].seatNumber,seatingType:D.seatingType}}};valid(OR(j.membershipNumber,j.programName))&&(S.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:j.membershipNumber,programName:j.programName}),c.push(S)}}return c.length?c:CONTINUE}}).call();