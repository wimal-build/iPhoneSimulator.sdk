// Copyright 2014 Apple Inc.  All Rights Reserved.
new ReverseTemplateList([new ReverseTemplate("alaskaair.com-confirmation-en",function(e){return/^Confirmation Letter - .*? - from Alaska Airlines$/.test(e.subject)},function(e){if(int(e.epoch)<1356998400)return CONTINUE;var r=Scanner.fromMessage(e);r.setLocale("en_US");var t,a,i,n,s,p,m,o,l,u,g,c,h,d,v,b,T,N,f,C=[],$={};if(/^Confirmation Letter/.test(e.subject)){t=r.getSpan().innerCapture(/\bConfirmation Code: (\w+)/,1),a=r.getSpan().nextText("Web Check-In").nextLink(),i=r.getSpan().nextText("SUMMARY OF AIRFARE CHARGES").withEnd(r.getSpan().nextText("Total Fare:").getStart()),u=r.getSpan().innerCapture(/Total Fare: ($<priceCurrency>[A-Z]{3}).*?($<totalPrice>[\d,.]+)\n/),l=u?u.$totalPrice:null,g=u?u.$priceCurrency:null;for(var y=/Traveler: ($<name>.*?)(?:, ($<programName>.*) # ($<membershipNumber>.*))?\nTicket: ($<ticketNumber>[-\d]+).*?\n[^]+?Traveler Total:.*?($<totalPrice>[\d,.]+)?\n/;i.innerRegExp(y).exists();)c=i.innerCapture(y),c&&($[""+c.$name]={name:c.$name,seats:{},seatingType:{},programName:c.$programName,membershipNumber:c.$membershipNumber,totalPrice:c.$totalPrice.result()||l,priceCurrency:g,ticketNumber:c.$ticketNumber}),i=i.withStart(i.innerRegExp(y).getEnd());m=r.getSpan().nextText("FLIGHT INFORMATION").withEnd(r.getSpan().nextText("SUMMARY OF AIRFARE CHARGES").getStart());for(var A,S=concatRegExp(/Flight: ($<airlineName>.*?) ($<flightNumber>\d+)\n[^]+?/,/(?:Confirmation code: ($<tmpReservationId>\w+)\n[^]+?)?/,/Departs: ($<departureAirport>.*?) \(($<departureCode>[A-Z]{3})\) ($<departureTime>.*?)\n/,/Arrives: ($<arrivalAirport>.*?) \(($<arrivalCode>[A-Z]{3})\) ($<arrivalTime>.*?)\n/,/Class: ($<seatingType>.*?)\nSeats: ($<seats>.*?)\n/),x=[],R=/(\d{1,}[A-Z])/;m.innerRegExp(S).exists();){if(p=m.innerCapture(S),valid(p)){for(h=p.$airlineName,o=p.$flightNumber,v=p.$departureAirport,b=p.$departureCode,d=p.$departureTime,N=p.$arrivalAirport,f=p.$arrivalCode,T=p.$arrivalTime,s=p.$seatingType,n=p.$seats,x=[];n.innerRegExp(R).exists();)x.push(n.innerCapture(R,1)),n=n.withStart(n.innerRegExp(R).getEnd());if(valid(o)){i=Object.keys($);for(var k=0;i.length>k;k++)valid(s)&&($[i[k]].seatingType[""+o]=s),valid(x)&&($[i[k]].seats[""+o]=x[k])}A=p.$tmpReservationId,ASSERT(h,o,b,d,f,T)&&C.push({airlineName:h,flightNumber:o,reservationId:A,departureAirport:v,departureCode:b,departureTime:d,arrivalAirport:N,arrivalCode:f,arrivalTime:T,passengers:$})}m=m.withStart(m.innerRegExp(S).getEnd())}}for(var E=[],F=0;C.length>F;F++)for(var I=C[F],z=Object.keys(I.passengers),P=0;z.length>P;P++){var M=I.passengers[z[P]];schema={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:I.airlineName,airlineCode:I.airlineCode,flightNumber:I.flightNumber,departureAirportFuzzy:I.departureAirport,departureAirportCode:I.departureCode,departureTime:I.departureTime,arrivalAirportFuzzy:I.arrivalAirport,arrivalAirportCode:I.arrivalCode,arrivalTime:I.arrivalTime},underName:{"@type":"http://schema.org/Person",name:M.name},checkinUrl:a,reservationStatus:"http://schema.org/Reservation"+(I.reservationStatus||"Confirmed"),reservationId:valid(I.reservationId)?I.reservationId:t,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:M.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:M.seats[I.flightNumber],seatingType:M.seatingType[I.flightNumber]}},totalPrice:M.totalPrice,priceCurrency:M.priceCurrency},not(M.membershipNumber)||(schema.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:M.membershipNumber,programName:M.programName}),E.push(schema)}return E.length?E:void 0},"0/1/2/3/4/5/3/5/6/6/6/6/4/7/112/160/162","SG767719db"),new ReverseTemplate("alaskaair.com-itineraries-receipts-en",function(e){return/^(?:Receipt|Itinerary)? sent from alaskaair\.com/.test(e.subject)},function(e){if(int(e.epoch)<1356998400)return CONTINUE;var r=Scanner.fromMessage(e);r.setLocale("en_US");var t,a,i,n,s,p,m,o,l,u,g,c,h,d,v,b=[],T={};if(/^(?:Receipt|Itinerary) sent from alaskaair\.com/.test(e.subject)){n=r.getSpan().nextText("Traveler Information").nextTag("table1").allInnerTags("tr1").map(function(e){return e.allInnerTagsFiltered("td1")});for(var N=1;n.length>N;N++)if(n[N].length>2){if(l=n[N][0].innerCapture(/\bName:\s+($<name>.*)\s+MP#:\s+(?:($<membershipNumber>.*)\s+-\s+($<programName>.*)\s+)?E-Ticket:(?:\s+($<ticketNumber>\d+))?/)){i=(""+l.$name.trim()).replace(/\s{2,}/," ");var f=l.$programName.trim(),C=l.$membershipNumber,$=l.$ticketNumber}seatList=n[N][1].split(",").map(function(e){return"No Seats"==e.trim()?"":e.trim()}),valid(i)&&(o=r.getSpan().nextRegExp(RegExp("Airfare for "+regExpEscape(i))).parentTag("tr1").lastInnerTag("td1").tagContents().innerCapture(/([\d,.]+)/,1),not(o)&&(o=r.getSpan().innerCapture(/Total per Traveler\s+.*?([\d,.]+)/,1)),T[i]={name:i,programName:f,membershipNumber:C,ticketNumber:$,totalPrice:o,seatList:seatList,seats:{},seatingType:{}})}p=r.getSpan().nextText("Departs").nextText("Arrives").parentTag("table1").allInnerTags("td1").filter(function(e){return e.innerTag("table2").exists()});for(var y=0;p.length>y;y++)if(s=p[y].innerTag("table2").allInnerTagsFiltered("td2"),s.length>=5){u=s[0].innerCapture(/($<name>.*)\s+($<flightNumber>\d+)/),g=u?u.$name.trim():null,m=u?u.$flightNumber:null,h=s[1].innerCapture(/\(([A-Z]{3})\)/,1),c=getFuzzyDate(s[2]),v=s[3].innerCapture(/\(([A-Z]{3})\)/,1),d=getFuzzyDate(s[4]);var A=null;valid(g,m)&&(A=p[y].innerCapture(RegExp(regExpEscape(""+g)+"\\s+"+regExpEscape(""+m)+"\\s+(.*?)\\s+\\|"),1)),n=Object.keys(T);for(var N=0;n.length>N;N++)not(A)||(T[n[N]].seatingType[""+m]=A),T[n[N]].seats[m]=T[n[N]].seatList[b.length];ASSERT(g,m,h,c,v,d)&&b.push({airlineName:g,flightNumber:m,departureCode:h,departureTime:c,arrivalCode:v,arrivalTime:d,passengers:T})}}for(var S=[],y=0;b.length>y;y++)for(var x=b[y],R=Object.keys(x.passengers),k=0;R.length>k;k++){var E=x.passengers[R[k]];schema={"@context":"http://schema.org","@type":"http://schema.org/FlightReservation",reservationFor:{"@type":"http://apple.com/FuzzyFlight",airlineName:x.airlineName,airlineCode:x.airlineCode,flightNumber:x.flightNumber,departureAirportFuzzy:x.departureAirport,departureAirportCode:x.departureCode,departureTime:x.departureTime,arrivalAirportFuzzy:x.arrivalAirport,arrivalAirportCode:x.arrivalCode,arrivalTime:x.arrivalTime},underName:{"@type":"http://schema.org/Person",name:E.name},checkinUrl:a,reservationStatus:"http://schema.org/Reservation"+(x.reservationStatus||"Confirmed"),reservationId:valid(x.reservationId)?x.reservationId:t,reservedTicket:{"@type":"http://schema.org/Ticket",ticketNumber:E.ticketNumber,ticketedSeat:{"@type":"http://schema.org/Seat",seatNumber:E.seats[x.flightNumber],seatingType:E.seatingType[x.flightNumber]}},totalPrice:E.totalPrice,priceCurrency:E.priceCurrency},not(E.membershipNumber)||(schema.programMembershipUsed={"@type":"http://schema.org/ProgramMembership",membershipNumber:E.membershipNumber,programName:E.programName}),S.push(schema)}return S.length?S:void 0},"0/1/2/3/4/5/3/5/6/6/6/6/4/7/112/160/163","SG5be839a5")]);